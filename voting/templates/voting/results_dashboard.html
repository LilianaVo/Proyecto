{% extends "base.html" %} 
{% block title %}Panel de Auditor√≠a de Votos{% endblock title %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
    /* Estilo para asegurar que los hashes NO se corten, sino que salten de l√≠nea */
    .hash-complete {
        word-break: break-all; 
        font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
        font-size: 0.75rem; 
        line-height: 1.3; 
    }
    /* ASIGNAR ANCHO M√çNIMO A LAS COLUMNAS CRIPTOGR√ÅFICAS (Aumenta el espacio) */
    .hash-column {
        min-width: 250px; 
    }
    .date-column {
        min-width: 140px; 
    }
    .voter-column {
        min-width: 150px; 
    }
    .id-column {
        min-width: 60px; 
    }
    /* ESTILO PARA COLUMNAS DE RESPUESTA LEGIBLE (ADMIN VIEW) */
    .answer-column {
        min-width: 100px;
        font-weight: bold;
    }
    .text-primary-strong {
        color: #1a2b41;
    }
    /* ESTILO ADICIONAL PARA LA DESCRIPCI√ìN EN PUNTOS */
    .crypto-list {
        list-style: none; 
        padding-left: 0;
        margin-bottom: 0;
    }
    .crypto-list li {
        margin-bottom: 5px;
        font-weight: 500;
    }
    /* ESTILO PARA EL CONTENEDOR CENTRAL DE VOTOS */
    .total-votes-container {
        max-width: 300px; 
        margin-left: auto;
        margin-right: auto;
    }
    .table-dark th {
        vertical-align: middle; 
    }
    /* --- NUEVO ESTILO PARA LA ALERTA M√ÅS GRANDE --- */
    .custom-large-alert .alert-message {
        font-size: 1.15rem; /* Mensaje m√°s grande */
    }
    /* --- FIN NUEVO ESTILO --- */
</style>
{% endblock extra_head %}

{% block content %}
<div class="container my-5">
    {# --- SECCI√ìN DE MENSAJES FLASH ELIMINADA DE AQU√ç. AHORA SOLO SE MUESTRA EN base.html --- #}

    <div class="row">
        <div class="col-12 text-center">
            <h1 class="text-dark fw-bolder fs-2">
                {% if is_verification_page %}
                    <i class="bi bi-patch-check-fill me-2 text-success"></i> Verificaci√≥n de Participaci√≥n
                {% elif is_audit_page %}
                    REGISTRO INMUTABLE DE AUDITOR√çA (ADMINISTRADOR)
                {% else %}
                    <i class="bi bi-bar-chart-fill me-2 text-info"></i> REGISTRO DE RESULTADOS DE ENCUESTA
                {% endif %}
            </h1>
            <p class="lead text-muted">
                {% if is_verification_page %}
                    ¬°Aqu√≠ puedes verificar el registro de tu voto para asegurar su integridad!
                {% elif is_audit_page %}
                    Detalle de la cadena de integridad y firma de no repudio
                {% else %}
                    Garantizando transparencia y capacidad de auditor√≠a
                {% endif %}
            </p>
              {# L√≠nea divisoria #}
            <hr class="my-4 border-secondary">
        </div>
    </div>
    
    
    {% if not is_verification_page and not is_audit_page %}
    
        <div class="row mb-5 mt-4 justify-content-center">
            <div class="col-md-4 mb-4 total-votes-container">
                <div class="card shadow-lg border-bottom border-primary border-5 h-100 rounded-3">
                    <div class="card-body text-center p-4">
                        <h5 class="card-title text-primary fw-bold">TOTAL DE VOTOS REGISTRADOS</h5>
                        <p class="display-3 fw-bolder text-dark mt-2">{{ total_votes }}</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mb-5 mt-4">
            <div class="col-md-6 mb-4">
                <div class="card shadow-lg h-100 rounded-3">
                    <div class="card-header bg-light py-3 rounded-top">
                        <h5 class="fw-bold mb-0 text-dark">Pregunta 1 (Inter√©s General)</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="chartP1" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6 mb-4">
                <div class="card shadow-lg h-100 rounded-3">
                    <div class="card-header bg-light py-3 rounded-top">
                        <h5 class="fw-bold mb-0 text-dark">Pregunta 2 (Dificultad)</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="chartP2" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-5 mt-4">
            <div class="col-md-6 mb-4">
                <div class="card shadow-lg h-100 rounded-3">
                    <div class="card-header bg-light py-3 rounded-top">
                        <h5 class="fw-bold mb-0 text-dark">Pregunta 3 (Utilidad)</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="chartP3" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6 mb-4">
                <div class="card shadow-lg h-100 rounded-3">
                    <div class="card-header bg-light py-3 rounded-top">
                        <h5 class="fw-bold mb-0 text-dark">Pregunta 4 (Ritmo)</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="chartP4" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </div>
        {% elif is_audit_page %}
        <div class="row">
            <div class="col-12">
                <h2 class="text-secondary fw-bold mt-5 mb-3 border-bottom pb-2">Detalles de la auditor√≠a de los votos</h2>
                
                <div class="p-4 mb-4 rounded bg-white border shadow-sm">
                    <h5 class="fw-bold text-dark mb-3">üìã Cuestionario Auditado ‚Äî Preguntas 1 a 4</h5>
                    <div class="row small text-muted">
                        <div class="col-md-6 mb-2">
                            <p class="mb-1"><strong>1. Inter√©s (P1):</strong> ¬øCu√°l fue tu nivel de inter√©s general en los temas vistos en la clase?</p>
                            <span class="ms-3 me-2">a) Alto</span> | <span class="me-2">b) Medio</span> | <span class="me-2">c) Bajo</span>
                        </div>
                        <div class="col-md-6 mb-2">
                            <p class="mb-1"><strong>2. Dificultad (P2):</strong> ¬øC√≥mo te pareci√≥ la dificultad de las tareas y proyectos del curso?</p>
                            <span class="ms-3 me-2">a) F√°ciles</span> | <span class="me-2">b) Adecuados</span> | <span class="me-2">c) Dif√≠ciles</span>
                        </div>
                        <div class="col-md-6 mb-2">
                            <p class="mb-1"><strong>3. Utilidad (P3):</strong> ¬øConsideras que los conceptos aprendidos en la clase te ser√°n √∫tiles?</p>
                            <span class="ms-3 me-2">a) S√≠, mucho</span> | <span class="me-2">b) Tal vez</span> | <span class="me-2">c) No, lo dudo</span>
                        </div>
                        <div class="col-md-6 mb-2">
                            <p class="mb-1"><strong>4. Ritmo (P4):</strong> ¬øC√≥mo calificar√≠as el ritmo al que se cubrieron los temas durante el semestre?</p>
                            <span class="ms-3 me-2">a) Muy r√°pido</span> | <span class="me-2">b) Adecuado</span> | <span class="me-2">c) Muy lento</span>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-bordered table-hover small shadow-sm rounded-3 overflow-hidden">
                        <thead class="table-dark">
                            <tr>
                                <th class="id-column">ID</th>
                                <th class="answer-column">Inter√©s (P1)</th>
                                <th class="answer-column">Dificultad (P2)</th>
                                <th class="answer-column">Utilidad (P3)</th>
                                <th class="answer-column">Ritmo (P4)</th>
                                <th class="text-center hash-column">Voto cifrado</th> 
                                <th class="text-center hash-column">Firma digital</th>
                                <th class="voter-column">Votante</th>
                                <th class="date-column">Fecha y hora</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for vote in votes %}
                            <tr class="align-middle">
                                <td>{{ vote.id }}</td>
                                <td class="text-primary answer-column">{{ vote.P1 }}</td>
                                <td class="answer-column">{{ vote.P2 }}</td>
                                <td class="answer-column">{{ vote.P3 }}</td>
                                <td class="answer-column">{{ vote.P4 }}</td>
                                
                                <td class="text-break text-center text-secondary fst-italic hash-complete hash-column">
                                    {{ vote.encrypted_vote }}
                                </td>
                                <td class="text-break text-center text-success fw-bold hash-complete hash-column">
                                    {{ vote.digital_signature }}
                                </td>
                                <td>{{ vote.voter_username }}</td>
                                <td>{{ vote.timestamp|date:"Y-m-d H:i:s" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="9" class="text-center p-4 text-muted">A√∫n no hay votos registrados en la auditor√≠a.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
    {% elif is_verification_page %}
        <div class="row justify-content-center mt-5 pt-4">
            <div class="col-md-10">
                <table class="table table-striped table-bordered table-hover small shadow-sm rounded-3 overflow-hidden mt-4">
                    <thead class="table-dark">
                        <tr>
                            <th class="voter-column">Votante</th>
                            <th class="id-column">ID Voto</th>
                            <th class="text-center hash-column">Voto cifrado</th> 
                            <th class="text-center hash-column">Firma digital</th>
                            <th class="date-column">Fecha y hora del registro</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for vote in votes %}
                        <tr class="align-middle">
                            <td>{{ vote.voter.user.username }}</td>
                            <td>{{ vote.id }}</td>
                            <td class="text-break text-center text-secondary fst-italic hash-complete hash-column">
                                {{ vote.encrypted_vote }}
                            </td>
                            <td class="text-break text-center text-success fw-bold hash-complete hash-column">
                                {{ vote.digital_signature }}
                            </td>
                            <td>{{ vote.timestamp|date:"Y-m-d H:i:s" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center p-4 text-muted">Tu voto a√∫n no ha sido registrado.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% endif %}
    </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script>
    // --- L√ìGICA DE DIBUJO DE GR√ÅFICOS SOLO SI NO ES LA P√ÅGINA DE VERIFICACI√ìN O AUDITOR√çA ---
    
    {% if not is_verification_page and not is_audit_page %} 
    
    // Funci√≥n para dibujar un gr√°fico de dona/anillo
    function drawChart(elementId, optionsJson, countsJson, titleText) {
        // Parsear los datos de JSON.
        const labels = JSON.parse(optionsJson);
        const data = JSON.parse(countsJson);

        // Si no hay datos (porque la lista est√° vac√≠a), muestra un mensaje y termina.
        if (data.length === 0 || data.every(count => count === 0)) {
            const ctx = document.getElementById(elementId);
            if (ctx) {
                const parent = ctx.parentElement;
                // Sustituimos el canvas por un mensaje
                parent.innerHTML = '<div class="text-center p-5 text-muted">A√∫n no hay votos registrados para este an√°lisis.</div>';
            }
            return; 
        }

        const backgroundColors = [
            'rgba(41, 121, 255, 0.9)',  // Azul
            'rgba(255, 99, 132, 0.9)', // Rojo
            'rgba(255, 193, 7, 0.9)',  // Amarillo
            'rgba(40, 167, 69, 0.9)',  // Verde
            'rgba(153, 102, 255, 0.9)', // Violeta
        ];
        
        const borderColors = backgroundColors.map(color => color.replace('0.9', '1'));

        const ctx = document.getElementById(elementId).getContext('2d');
        
        new Chart(ctx, {
            type: 'doughnut', 
            data: {
                labels: labels,
                datasets: [{
                    label: 'Votos',
                    data: data,
                    backgroundColor: backgroundColors.slice(0, labels.length),
                    borderColor: borderColors.slice(0, labels.length),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: { size: 14, family: 'Inter' }
                        }
                    },
                    title: {
                        display: true,
                        text: titleText, 
                        font: { size: 18, weight: 'bold' }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                // C√°lculo de porcentaje
                                const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                const currentValue = context.raw;
                                const percentage = ((currentValue / total) * 100).toFixed(1);

                                return label + currentValue + ' votos (' + percentage + '%)';
                            }
                        }
                    }
                },
            },
        });
    }

    // --- Dibujar los 4 gr√°ficos ---
    drawChart(
        'chartP1',
        '{{ options_json_p1|safe|escapejs|default:"[]" }}', 
        '{{ counts_json_p1|safe|escapejs|default:"[]" }}',
        'Distribuci√≥n de Inter√©s General'
    );
    
    drawChart(
        'chartP2',
        '{{ options_json_p2|safe|escapejs|default:"[]" }}',
        '{{ counts_json_p2|safe|escapejs|default:"[]" }}',
        'Dificultad de Tareas y Proyectos'
    );

    drawChart(
        'chartP3',
        '{{ options_json_p3|safe|escapejs|default:"[]" }}',
        '{{ counts_json_p3|safe|escapejs|default:"[]" }}',
        'Utilidad de los Conceptos Aprendidos'
    );
    
    drawChart(
        'chartP4',
        '{{ options_json_p4|safe|escapejs|default:"[]" }}',
        '{{ counts_json_p4|safe|escapejs|default:"[]" }}',
        'Ritmo de Cobertura de Temas'
    );
    
    {% endif %}

</script>
{% endblock content %}